generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://gcdbuser:13784652r@localhost:5432/newgamecube?schema=public"
}

model User {
  id              Int      @id @default(autoincrement())
  uuid            String   @unique @default(uuid())
  phone           String   @unique
  roles           String[] @default(["user"])
  password        String
  isPhoneVerified Boolean  @default(false)
  isEmailVerified Boolean  @default(false)
  isVerified      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  profile              Profile?
  managedOrganizations UserOrganization[]
  reservations         Reservation[]

  @@index([phone]) // Additional index for faster phone lookups
  @@map("users")
}

model Profile {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique
  fName        String?
  lName        String?
  email        String?
  nationalCode String?
  province     String?
  city         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model OtpCode {
  id        Int      @id @default(autoincrement())
  phone     String
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
  @@map("otp_codes")
}

model Organization {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  name          String
  username      String?  @unique
  province      String
  city          String
  phoneNumber   String
  email         String?
  managerPhones String[]
  gallery       String[]
  indexImage    String?
  logoImage     String?
  address       String?
  description   String?  @db.VarChar(400)
  latitude      Decimal?
  longitude     Decimal?
  tfHour        Boolean  @default(false)
  isCube        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  stations     Station[]
  managers     UserOrganization[]
  workingHours OrganizationWorkingHours[]
  reservations Reservation[]

  @@index([uuid])
  @@index([username])
  @@index([province])
  @@index([city])
  @@index([latitude, longitude])
  @@index([province, city, latitude, longitude]) // For location-based filtering
  @@map("organizations")
}

model OrganizationWorkingHours {
  id             Int      @id @default(autoincrement())
  organizationId Int
  dayOfWeek      Int // 0 = Saturday, 1 = Sunday, 2 = Monday, 3 = Tuesday, 4 = Wednesday, 5 = Thursday, 6 = Friday
  isClosed       Boolean  @default(false)
  is24Hours      Boolean  @default(false)
  startTime      String? // Format: "HH:MM" (e.g., "09:00")
  endTime        String? // Format: "HH:MM" (e.g., "22:00")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, dayOfWeek])
  @@index([organizationId])
  @@index([dayOfWeek])
  @@index([organizationId, dayOfWeek])
  @@index([isClosed, is24Hours])
  @@map("organization_working_hours")
}

model Game {
  id              Int      @id @default(autoincrement())
  title           String
  description     String?
  coverImage      String?
  category        String[]
  releaseYear     Int
  displayPriority Int      @default(0)
  isAccepted      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  consoles Console[]
  stations StationGame[]

  @@index([isAccepted])
  @@index([displayPriority])
  @@map("games")
}

model Console {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  manufacturer    String?
  releaseYear     Int
  category        String
  displayPriority Int       @default(0)
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  games        Game[]
  stations     Station[]
  reservations Reservation[]

  @@index([category])
  @@index([displayPriority])
  @@index([deletedAt])
  @@map("consoles")
}

model Station {
  id             Int       @id @default(autoincrement())
  organizationId Int
  title          String
  consoleId      Int
  capacity       Int
  status         Boolean   @default(false)
  isActive       Boolean   @default(true)
  isAccepted     Boolean   @default(false)
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  console      Console          @relation(fields: [consoleId], references: [id], onDelete: Restrict)
  stationGames StationGame[]
  pricings     StationPricing[]
  reservations Reservation[]

  @@index([organizationId])
  @@index([consoleId])
  @@index([deletedAt])
  @@index([isAccepted, isActive, deletedAt])
  @@index([consoleId, deletedAt])
  @@index([organizationId, deletedAt])
  @@index([organizationId, consoleId, isActive, isAccepted, deletedAt]) // For optimized search
  @@index([organizationId, capacity, isActive, isAccepted, deletedAt]) // For playerCount filter
  @@map("stations")
}

model StationGame {
  id        Int      @id @default(autoincrement())
  stationId Int
  gameId    Int
  createdAt DateTime @default(now())

  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)
  game    Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([stationId, gameId])
  @@index([stationId])
  @@index([gameId])
  @@index([gameId, stationId])
  @@map("station_games")
}

model StationPricing {
  id          Int      @id @default(autoincrement())
  stationId   Int
  playerCount Int // Number of players (1, 2, 3, ...)
  price       Float // Price for this number of players
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)

  @@unique([stationId, playerCount])
  @@index([stationId])
  @@index([playerCount])
  @@index([stationId, playerCount])
  @@map("station_pricings")
}

model UserOrganization {
  id             Int      @id @default(autoincrement())
  userId         Int
  organizationId Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([userId, organizationId])
  @@map("user_organizations")
}

model Reservation {
  id             Int      @id @default(autoincrement())
  uuid           String   @unique @default(uuid())
  userId         Int? // Nullable: when gaming cafe blocks it
  organizationId Int
  stationId      Int
  consoleId      Int
  playerCount    Int // Number of players
  price          Float // Reservation amount (in Rials or Tomans)
  invoiceId      String? // Invoice number - currently without relation
  isPaid         Boolean  @default(false)
  isAccepted     Boolean  @default(false) // Approved by gaming cafe
  isBlockedByOrg Boolean  @default(false) // Is blocked by gaming cafe?
  startTime      DateTime // Reservation start time
  endTime        DateTime // Reservation end time
  reservedDate   DateTime // Reservation date (without time) - for faster queries
  notes          String? // Additional notes
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  station      Station      @relation(fields: [stationId], references: [id], onDelete: Cascade)
  console      Console      @relation(fields: [consoleId], references: [id], onDelete: Restrict)

  // Optimized indexes for different queries
  @@index([uuid])
  @@index([userId])
  @@index([organizationId])
  @@index([stationId])
  @@index([consoleId])
  @@index([reservedDate]) // For date-based search
  @@index([startTime, endTime]) // For checking time overlap
  @@index([stationId, reservedDate]) // For batch query of reservations

  // Composite indexes for complex queries
  @@index([organizationId, reservedDate, startTime]) // Search reservations for a gaming cafe in one day
  @@index([stationId, reservedDate, startTime, endTime]) // Check station availability - MOST IMPORTANT
  @@index([consoleId, reservedDate, startTime]) // Search by console type
  @@index([reservedDate, startTime, endTime, isPaid, isAccepted]) // Active reservations
  @@index([organizationId, isAccepted, isPaid]) // Manage pending reservations
  @@index([userId, reservedDate]) // User reservation history

  @@map("reservations")
}
