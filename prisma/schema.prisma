generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://gcdbuser:13784652r@localhost:5432/newgamecube?schema=public"
}

model User {
  id              Int      @id @default(autoincrement())
  uuid            String   @unique @default(uuid())
  phone           String   @unique
  roles           String[] @default(["user"])
  password        String
  isPhoneVerified Boolean  @default(false)
  isEmailVerified Boolean  @default(false)
  isVerified      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  profile              Profile?
  managedOrganizations UserOrganization[]
  reservations         Reservation[]

  @@map("users")
}

model Profile {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique
  fName        String?
  lName        String?
  email        String?
  nationalCode String?
  province     String?
  city         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model OtpCode {
  id        Int      @id @default(autoincrement())
  phone     String
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
  @@map("otp_codes")
}

model Organization {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  name          String
  username      String?  @unique
  province      String
  city          String
  phoneNumber   String
  email         String?
  managerPhones String[]
  gallery       String[]
  indexImage    String?
  logoImage     String?
  address       String?
  description   String?  @db.VarChar(400)
  latitude      Decimal?
  longitude     Decimal?
  tfHour        Boolean  @default(false)
  isCube        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  stations     Station[]
  managers     UserOrganization[]
  workingHours OrganizationWorkingHours[]
  reservations Reservation[]
  sessions     Session[]

  @@index([province, city, latitude, longitude]) // For location-based filtering (covers province and city queries too)
  @@map("organizations")
}

model OrganizationWorkingHours {
  id             Int      @id @default(autoincrement())
  organizationId Int
  dayOfWeek      Int // 0 = Saturday, 1 = Sunday, 2 = Monday, 3 = Tuesday, 4 = Wednesday, 5 = Thursday, 6 = Friday
  isClosed       Boolean  @default(false)
  is24Hours      Boolean  @default(false)
  startTime      String? // Format: "HH:MM" (e.g., "09:00")
  endTime        String? // Format: "HH:MM" (e.g., "22:00")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, dayOfWeek])
  @@index([dayOfWeek]) // For querying all organizations by specific day
  @@index([isClosed, is24Hours])
  @@map("organization_working_hours")
}

model Game {
  id              Int      @id @default(autoincrement())
  title           String
  description     String?
  coverImage      String?
  category        String[]
  releaseYear     Int
  displayPriority Int      @default(0)
  isAccepted      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  consoles Console[]
  stations StationGame[]

  @@index([isAccepted])
  @@index([displayPriority])
  @@map("games")
}

model Console {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  manufacturer    String?
  releaseYear     Int
  category        String
  displayPriority Int       @default(0)
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  games        Game[]
  stations     Station[]
  reservations Reservation[]

  @@index([category])
  @@index([displayPriority])
  @@index([deletedAt])
  @@map("consoles")
}

model Station {
  id             Int       @id @default(autoincrement())
  organizationId Int
  title          String
  consoleId      Int
  capacity       Int
  status         Boolean   @default(false)
  isActive       Boolean   @default(true)
  isAccepted     Boolean   @default(false)
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  console      Console          @relation(fields: [consoleId], references: [id], onDelete: Restrict)
  stationGames StationGame[]
  pricings     StationPricing[]
  reservations Reservation[]
  sessions     Session[]

  @@index([organizationId])
  @@index([consoleId])
  @@index([deletedAt])
  @@index([isAccepted, isActive, deletedAt])
  @@index([consoleId, deletedAt])
  @@index([organizationId, deletedAt])
  @@index([organizationId, consoleId, isActive, isAccepted, deletedAt]) // For optimized search
  @@index([organizationId, capacity, isActive, isAccepted, deletedAt]) // For playerCount filter
  @@map("stations")
}

model StationGame {
  id        Int      @id @default(autoincrement())
  stationId Int
  gameId    Int
  createdAt DateTime @default(now())

  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)
  game    Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([stationId, gameId])
  @@index([gameId]) // For reverse lookup: which stations have this game
  @@map("station_games")
}

model StationPricing {
  id          Int      @id @default(autoincrement())
  stationId   Int
  playerCount Int // Number of players (1, 2, 3, ...)
  price       Float // Price for this number of players
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)

  @@unique([stationId, playerCount])
  @@index([playerCount]) // For global price comparison queries
  @@map("station_pricings")
}

model UserOrganization {
  id             Int      @id @default(autoincrement())
  userId         Int
  organizationId Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId]) // For reverse lookup: which users manage this organization
  @@map("user_organizations")
}

model Reservation {
  id             Int      @id @default(autoincrement())
  uuid           String   @unique @default(uuid())
  userId         Int? // Nullable: when gaming cafe blocks it
  organizationId Int
  stationId      Int
  consoleId      Int
  playerCount    Int // Number of players
  price          Float // Reservation amount (in Rials or Tomans)
  invoiceId      String? // Invoice number - currently without relation
  isPaid         Boolean  @default(false)
  isAccepted     Boolean  @default(false) // Approved by gaming cafe
  isBlockedByOrg Boolean  @default(false) // Is blocked by gaming cafe?
  startTime      DateTime // Reservation start time
  endTime        DateTime // Reservation end time
  reservedDate   DateTime @db.Date // Reservation date (without time) - for faster queries
  notes          String? // Additional notes
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  station      Station      @relation(fields: [stationId], references: [id], onDelete: Cascade)
  console      Console      @relation(fields: [consoleId], references: [id], onDelete: Restrict)

  // Optimized composite indexes for complex queries
  @@index([stationId, reservedDate, startTime, endTime]) // Check station availability - MOST CRITICAL
  @@index([organizationId, reservedDate, isPaid, isAccepted]) // Organization's daily reservations with status
  @@index([userId, reservedDate]) // User reservation history
  @@index([reservedDate, isPaid, isAccepted]) // Active reservations globally

  @@map("reservations")
}

model Invoice {
  id          Int      @id @default(autoincrement())
  uuid        String   @unique @default(uuid())
  userId      Int
  sessionId   Int
  price       BigInt // Max: 1000000000
  priceBefore BigInt? // Max: 1000000000
  tax         BigInt // Max: 1000000000
  taxBefore   BigInt? // Max: 1000000000
  contentId   Int      @unique
  status      String   @default("not paid")
  paymentId   Int?
  dueDate     DateTime // 15 minutes after create date
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  content InvoiceContent @relation(fields: [contentId], references: [id], onDelete: Restrict)
  session Session?

  @@index([userId, status]) // User's invoices by status
  @@index([status, dueDate]) // For processing overdue invoices
  @@index([paymentId]) // For payment gateway callback lookup
  @@map("invoices")
}

model InvoiceContent {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice Invoice?

  @@map("invoice_contents")
}

model Session {
  id               Int      @id @default(autoincrement())
  uuid             String   @unique @default(uuid())
  organizationId   Int
  stationId        Int
  date             DateTime @db.Date // Only date without time
  shamsiDate       String   @db.VarChar(10) // Iranian Shamsi date "1403/09/07"
  startTime        String   @db.VarChar(5) // "13:00"
  endTime          String?  @db.VarChar(5) // "14:30" - nullable
  startTimeMinutes Int      @db.SmallInt // 780 (13*60) - minutes from start of day (0-1439)
  endTimeMinutes   Int?     @db.SmallInt // 870 (14*60 + 30) - nullable (0-1439)
  duration         Int      @db.SmallInt // Duration in minutes: 90 (max ~546 = 9 hours)
  playersCount     Int      @db.SmallInt // Number of players (1-10)
  status           String   @db.VarChar(20) // reserved, inprogress, pending, finished, canceled, revoked
  invoiceId        Int      @unique
  expireAt         DateTime // 10 minutes after creation
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  station      Station      @relation(fields: [stationId], references: [id], onDelete: Cascade)
  invoice      Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Restrict)

  // Optimized indexes for availability queries
  @@index([stationId, date, startTimeMinutes, endTimeMinutes]) // MOST CRITICAL - for checking station availability
  @@index([organizationId, date, status]) // For organization's daily sessions
  @@index([expireAt, status]) // For cleaning expired sessions with pending status
  @@map("sessions")
}

/// System Settings - Global configuration for the application
/// Currently used for tax settings, can be extended for other settings
model SystemSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100) // e.g., "tax_enabled", "tax_rate", "tax_type"
  value     String   @db.VarChar(255) // Value as string (can be parsed as needed)
  dataType  String   @db.VarChar(20) // "boolean", "number", "string", "percentage"
  category  String   @db.VarChar(50) // "tax", "payment", "general", etc.
  label     String   @db.VarChar(255) // Human-readable label in Persian
  description String? @db.Text // Optional description
  isActive  Boolean  @default(true) // Can be used to soft-delete settings
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category, isActive])
  @@map("system_settings")
}
